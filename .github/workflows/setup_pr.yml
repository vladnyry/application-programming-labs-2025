name: Подготовка PR к ревью

on:
  pull_request_target:
    types: [opened, reopened]

permissions: write-all

jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: Анализ заголовка PR для определения группы и номера лабораторной работы
        env:
          TITLE: ${{ github.event.pull_request.title }}
        run: |
          SUB='Лаб.'
          for VAR in 1 2 3 4 5
          do
            if echo "$TITLE" | grep -iqE "$SUB *$VAR"; then
                echo "LABEL=LAB $VAR" >> "$GITHUB_ENV"
                break
            fi
          done
          for VAR in 6211 6212 6213 6214
          do
              if (echo $TITLE | grep -iqF "$VAR" ); then
                  echo "GROUP=$VAR" >> "$GITHUB_ENV"
                  break
              fi      
          done

      - name: Проверка номера лабораторной работы
        run: |
          if [[ -z $LABEL ]]; then
              echo "Ошибка: Не удалось определить номер лабораторной работы из заголовка PR."
              exit 1
          fi
          echo "Успех: Номер лабораторной работы распознан корректно - $LABEL"

      - name: Проверка номера группы
        run: |
          if [[ -z $GROUP ]]; then
              echo "Ошибка: Не удалось определить номер группы из заголовка PR"
              exit 1
          fi
          echo "Успех: Номер группы распознан корректно - $GROUP"

      - name: Удаление всех меток
        if: github.event.action == 'reopened'
        uses: actions/github-script@v8
        with:
          script: |
            const issue_number = context.payload.pull_request.number;
            try {
              await github.rest.issues.removeAllLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
              });
            } catch (e) {
              if (e.status === 404) {
                core.info('Меток для удаления не найдено');
              } else {
                throw e;
              }
            }

      - name: Установка меток PR
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: |
            ${{ env.LABEL }}
            ${{ env.GROUP }}
            IN PROGRESS

      - name: Назначение ревьювера
        if: env.GROUP == '6211'
        uses: AveryCameronUofR/add-reviewer-gh-action@1.0.3
        with:
          reviewers: "microalan"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Назначение ревьювера
        if: env.GROUP == '6212'
        uses: AveryCameronUofR/add-reviewer-gh-action@1.0.3
        with:
          reviewers: "IlyaOv"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Назначение ревьювера
        if: env.GROUP == '6213'
        uses: AveryCameronUofR/add-reviewer-gh-action@1.0.3
        with:
          reviewers: "vfkon"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Назначение ревьювера
        if: env.GROUP == '6214'
        uses: AveryCameronUofR/add-reviewer-gh-action@1.0.3
        with:
          reviewers: "mxwrlld"
          token: ${{ secrets.GITHUB_TOKEN }}
